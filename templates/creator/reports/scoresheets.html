{% extends 'creator/base_creator.html' %}
{% load static %}
{% load osce_filters %}

{% block title %}Score Sheets - {{ session.name }}{% endblock %}

{% block extra_css %}
<style>
    @media print {
        @page {
            size: A4;
            margin: 0;
        }
        *, *::before, *::after {
            box-sizing: border-box !important;
        }
        html, body {
            height: auto !important;
            overflow: visible !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .sidebar, .btn, .no-print, .student-checkbox, .print-controls { display: none !important; }
        .hidden-from-print { display: none !important; }
        .score-sheet.hidden-from-print { display: none !important; }
        .main-content {
            margin: 0 !important;
            padding: 0 !important;
            min-height: auto !important;
            overflow: visible !important;
        }
        .page-break { page-break-after: always; }
        body {
            font-size: 11pt;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .score-sheet {
            width: 210mm !important;
            min-height: 297mm !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 10mm 20mm !important;
            padding-top: 55mm !important;
            box-shadow: none !important;
            box-sizing: border-box !important;
            display: block !important;
            page-break-inside: avoid;
            position: relative;
            background-image: url('{% static "images/letterhead-background.png" %}') !important;
            background-size: 210mm 297mm !important;
            background-position: top center !important;
            background-repeat: no-repeat !important;
        }

        .exam-title {
            font-size: 1.6rem;
            font-weight: 800;
            display: inline-block;
            text-align: center;
            padding-bottom: 6px;
            border-bottom: 3px solid #000;
            margin-bottom: 6px;
            direction: rtl;
        }
    }

    .score-sheet {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        padding-top: 40px;
    }

    .score-sheet::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background-image: url('{% static "images/letterhead-background.png" %}');
        background-size: contain;
        background-position: top center;
        background-repeat: no-repeat;
        opacity: 0.1;
        pointer-events: none;
    }

    .student-checkbox {
        position: absolute;
        top: 10px;
        right: 10px;
        transform: scale(1.5);
        cursor: pointer;
    }

    .score-sheet-header {
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }

    .station-score-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .station-score-row:last-child {
        border-bottom: none;
    }

    .total-row {
        background: #f8f9fa;
        padding: 8px 6px;
        border-radius: 4px;
        margin-top: 8px;
        font-weight: bold;
    }

    .print-controls {
        position: sticky;
        top: 0;
        background: white;
        z-index: 100;
        padding: 15px;
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center no-print">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'creator:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'creator:reports_index' %}">Reports</a></li>
                <li class="breadcrumb-item active">Score Sheets</li>
            </ol>
        </nav>
        <h1><i class="bi bi-file-earmark-text me-2"></i>Score Sheets - {{ session.name }}</h1>
    </div>
</div>

<!-- Search Box (cross-page) -->
{% if not single_student %}
<div class="no-print" style="background: white; padding: 15px; margin: 20px 0; border-radius: 8px; border: 1px solid #dee2e6;">
    <form method="get" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
        <input type="text" name="search" class="form-control" placeholder="Search by student name or number..." value="{{ search_query|default:'' }}" style="max-width: 400px; min-width: 150px; flex: 1 1 auto;">
        <button type="submit" class="btn btn-outline-secondary"><i class="bi bi-search"></i> Search</button>
        {% if search_query %}
        <a href="?" class="btn btn-outline-danger"><i class="bi bi-x"></i> Clear</a>
        {% endif %}
        <small class="text-muted ms-auto">{{ paginator.count }} total results</small>
    </form>
</div>
{% endif %}

{% if not single_student %}
<!-- Pagination Info Bar -->
<div class="no-print" style="background:#f8f9fa; padding:12px 15px; margin:20px 0; border-radius:8px; border:1px solid #dee2e6;">
    <div class="d-flex justify-content-between align-items-center">
        <div style="font-size:0.9rem; color:#495057;">
            {% if print_all %}
            <strong>All {{ paginator.count }} students</strong> &mdash; Print-ready
            {% else %}
            <strong>Page {{ page_obj.number }} of {{ paginator.num_pages }}</strong>
            &mdash; Showing {{ page_obj.object_list|length }} of {{ paginator.count }} students
            {% endif %}
        </div>
        {% if not print_all %}
        <div>
            {% if page_obj.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-double-left"></i></a>
            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-left"></i></a>
            {% endif %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-right"></i></a>
            <a href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-double-right"></i></a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% if not print_all %}
<div class="print-controls no-print">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAll()" id="selectAllBtn">
                <i class="bi bi-check-square me-1"></i><span id="selectAllText">Select All</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="deselectAll()">
                <i class="bi bi-square me-1"></i>Deselect All
            </button>
            <span class="text-muted small"><span id="selectedCount">0</span> of {{ page_obj.object_list|length }} selected on this page</span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="printSelected()">
                <i class="bi bi-printer me-1"></i>Print Selected
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                <i class="bi bi-printer-fill me-1"></i>Print This Page
            </button>
            <a href="?print_all=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-outline-success btn-sm" target="_blank">
                <i class="bi bi-printer-fill me-1"></i>Print All {{ paginator.count }} Students
            </a>
        </div>
    </div>
</div>
{% else %}
<div class="no-print" style="text-align:center; padding:10px 0;">
    <button class="btn btn-primary" onclick="window.print()"><i class="bi bi-printer me-2"></i>Print All {{ paginator.count }} Students</button>
    <a href="?" class="btn btn-outline-secondary ms-2"><i class="bi bi-arrow-left me-1"></i>Back to Paginated View</a>
</div>
{% endif %}
{% else %}
<div class="text-center no-print mb-4">
    <button class="btn btn-primary btn-lg" onclick="window.print()">
        <i class="bi bi-printer me-2"></i>Print Score Sheet
    </button>
</div>
{% endif %}

{% for data in students %}
<div class="score-sheet {% if not forloop.last %}page-break{% endif %}" id="student-{{ data.student.id }}" data-student-id="{{ data.student.id }}">
    {% if not single_student %}
    <input type="checkbox" class="student-checkbox no-print" onchange="updateSelectedCount()">
    {% endif %}

    <div class="mb-4 text-center">
        <div class="exam-title">تقرير امتحان مفصل</div>
        <p class="mb-1" style="font-size: 1.25rem; direction: rtl; line-height: 1.6; margin-top:6px;">
            هذا التقرير الخاص بالطالب <strong>{{ data.student.full_name }}</strong> رقم تسجيله <strong>{{ data.student.student_number }}</strong>
            للامتحان السريري لمساق <strong>{{ session.exam.course.name }}</strong>
            الذي أقيم بتاريخ <strong>{{ session.session_date|date:"Y-m-d" }}</strong>
        </p>
    </div>

    <h6 class="text-uppercase text-muted mb-3 text-center">Station Scores</h6>

    {% for station in data.stations %}
    {% with scores_list=data.scores|get_item:station.id %}
    <div class="station-score-row">
        <div>
            <strong>{{ station.name }}</strong>
            {% if scores_list %}
                {% if scores_list|length == 1 %}
                    {% with score=scores_list|first %}
                    {% if score.examiner_id %}
                    <small class="text-muted ms-2">(Dr: {{ score.examiner.full_name|default:"N/A" }})</small>
                    {% endif %}
                    {% endwith %}
                {% else %}
                    <small class="text-muted ms-2">
                        (Dr: {% for score in scores_list %}{{ score.examiner.full_name|default:"Unknown" }}{% if not forloop.last %}, {% endif %}{% endfor %})
                    </small>
                {% endif %}
            {% endif %}
        </div>
        <div>
            {% if scores_list %}
                {% if scores_list|length == 1 %}
                    {% with score=scores_list|first %}
                    <span class="badge {% if score.percentage and score.percentage >= 60 %}bg-success{% else %}bg-danger{% endif %}">
                        {{ score.total_score|default:0|floatformat:2 }} / {{ score.max_score|default:0|floatformat:2 }}
                        ({{ score.percentage_display }}%)
                    </span>
                    {% endwith %}
                {% else %}
                    {% with first_score=scores_list|first %}
                    <span class="badge bg-info">
                        Avg: {{ scores_list|average_score }} / {{ first_score.max_score|default:0 }}
                    </span>
                    {% endwith %}
                {% endif %}
            {% else %}
            <span class="badge bg-secondary">Not Scored</span>
            {% endif %}
        </div>
    </div>
    {% endwith %}
    {% endfor %}

    <div class="total-row d-flex justify-content-between">
        <span>TOTAL</span>
        <span>
            {{ data.total_score|floatformat:2 }} / {{ data.max_score|floatformat:2 }}
            {% if data.max_score > 0 %}
            ({{ data.percentage_display }}%)
            —
            <span class="{% if data.passed %}text-success{% else %}text-danger{% endif %}">
                {% if data.passed %}PASS{% else %}FAIL{% endif %}
            </span>
            {% else %}
            <span class="text-muted">No Scores</span>
            {% endif %}
        </span>
    </div>

    {% if data.comments_with_examiner %}
    <div style="margin-top: 20px; padding: 12px; background: #f8f9fa; border-left: 4px solid #0d6efd; border-radius: 4px;">
        <h6 style="text-transform: uppercase; color: #495057; font-weight: 600; margin-bottom: 12px; margin-top: 0;">
            <i class="bi bi-chat-square-text"></i> Examiners' Comments
        </h6>
        {% for comment in data.comments_with_examiner %}
        <div style="margin-bottom: 12px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #6c757d;">
            <div style="font-weight: 600; color: #212529; margin-bottom: 4px;">
                {{ comment.examiner_name }} - {{ comment.station.name }}
            </div>
            <div style="color: #495057; white-space: pre-wrap; line-height: 1.5;">{{ comment.comment_text }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endfor %}

<!-- Bottom Pagination -->
{% if not single_student and not print_all %}
<div class="no-print" style="background:#f8f9fa; padding:12px 15px; margin:20px 0; border-radius:8px; border:1px solid #dee2e6; text-align:center;">
    <strong>Page {{ page_obj.number }} of {{ paginator.num_pages }}</strong>
    <div style="margin-top:10px;">
        {% if page_obj.has_previous %}
        <a href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-double-left"></i></a>
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-left"></i> Previous</a>
        {% endif %}
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary">Next <i class="bi bi-chevron-right"></i></a>
        <a href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-chevron-double-right"></i></a>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
    const el = document.getElementById('selectedCount');
    if (el) el.textContent = checked;
    const txt = document.getElementById('selectAllText');
    if (txt) txt.textContent = (checkboxes.length > 0 && checked === checkboxes.length) ? 'Deselect All' : 'Select All';
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.student-checkbox');
    const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateSelectedCount();
}

function deselectAll() {
    document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function printSelected() {
    const sheets = document.querySelectorAll('.score-sheet');
    const checkedStudentIds = new Set();
    sheets.forEach(sheet => {
        const checkbox = sheet.querySelector('.student-checkbox');
        if (checkbox && checkbox.checked) checkedStudentIds.add(sheet.dataset.studentId);
    });

    if (checkedStudentIds.size === 0) {
        alert('Please select at least one student to print.');
        return;
    }

    sheets.forEach(sheet => {
        if (!checkedStudentIds.has(sheet.dataset.studentId)) {
            sheet.classList.add('hidden-from-print');
        }
    });

    setTimeout(() => {
        window.print();
        setTimeout(() => {
            sheets.forEach(sheet => sheet.classList.remove('hidden-from-print'));
        }, 300);
    }, 50);
}

function printStudent(studentId) {
    const sheets = document.querySelectorAll('.score-sheet');
    const targetStudentId = studentId.toString();
    sheets.forEach(sheet => {
        if (sheet.dataset.studentId !== targetStudentId) sheet.classList.add('hidden-from-print');
    });
    setTimeout(() => {
        window.print();
        setTimeout(() => sheets.forEach(sheet => sheet.classList.remove('hidden-from-print')), 300);
    }, 50);
}

document.addEventListener('DOMContentLoaded', function() {
    {% if not single_student and not print_all %}
    updateSelectedCount();
    {% endif %}
    {% if print_all %}
    // Auto-trigger print in print_all mode
    setTimeout(() => window.print(), 500);
    {% endif %}
});
</script>
{% endblock %}
