{% extends 'creator/base_creator.html' %}
{% load static %}

{% block title %}Session - {{ session.name|default:"Session" }}{% endblock %}

{% block extra_css %}
<!-- Select2 for searchable examiner dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
<style>
/* ── Select2 inside modal fixes ───────────────────────────────────────── */
.select2-container--bootstrap-5 .select2-selection--single {
    height: calc(1.5em + 0.5rem + 2px) !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.875rem !important;
}
.select2-container--bootstrap-5 .select2-dropdown {
    z-index: 1060;
}
.select2-results__options {
    max-height: 220px !important;
    overflow-y: auto !important;
}

/* ── Live Student Search ──────────────────────────────────────────────── */
.student-search-wrapper { position: relative; max-width: 380px; }
.student-search-icon {
    position: absolute; left: 0.65rem; top: 50%; transform: translateY(-50%);
    color: #6c757d; pointer-events: none; font-size: 0.85rem;
}
.student-search-input {
    padding-left: 2rem !important;
    padding-right: 2.2rem !important;
}
.student-search-clear {
    position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
    background: none; border: none; color: #6c757d; cursor: pointer;
    padding: 0; font-size: 0.75rem; line-height: 1;
}
.student-search-clear:hover { color: #343a40; }

/* ── Session Info Alert ──────────────────────────────────────────────── */
.session-info-alert {
    background: linear-gradient(135deg, #FEF3C7 0%, #FCD34D 100%);
    border: 2px solid #F59E0B;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
}
.session-info-alert:hover {
    background: linear-gradient(135deg, #FCE5A8 0%, #FBD35F 100%);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}
.session-info-alert i.toggle-icon {
    display: inline-block;
    transition: transform 0.3s ease;
    margin-left: 0.5rem;
}
.session-info-alert.collapsed i.toggle-icon {
    transform: rotate(-90deg);
}

/* ── Path Card Badges (Hidden by Default) ──────────────────────────────── */
.path-details-toggle {
    display: none;
}
.path-details-toggle.show {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex flex-wrap justify-content-between align-items-start gap-2">

    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'creator:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'creator:exam_list' %}">Exams</a></li>
                <li class="breadcrumb-item"><a href="{% url 'creator:exam_detail' session.exam_id %}">{{ session.exam.name|default:"Exam" }}</a></li>
                <li class="breadcrumb-item active">Session</li>
            </ol>
        </nav>
        <h1>{{ session.name|default:"Exam Session" }}</h1>
        <p class="text-muted mb-0">
            <i class="bi bi-calendar me-1"></i>
            {% if session.session_date %}{{ session.session_date|date:"Y-m-d" }}{% else %}Date not set{% endif %}
            <span class="mx-2">&bull;</span>
            <span class="badge badge-{{ session.status }}">{{ session.status|title }}</span>
        </p>
    </div>
    <div class="btn-group flex-wrap">
        {% if session.status == 'scheduled' %}
        <button type="button" class="btn btn-success" onclick="activateSession()"><i class="bi bi-play-fill me-1"></i>Activate</button>
        {% if request.user.is_superuser %}
        <button type="button" class="btn btn-danger" onclick="hardDeleteSession()"><i class="bi bi-trash me-1"></i>Delete Permanently</button>
        {% endif %}
        {% elif session.status == 'in_progress' %}
        <button type="button" class="btn btn-warning" onclick="deactivateSession()"><i class="bi bi-pause-fill me-1"></i>Pause</button>
        <button type="button" class="btn btn-secondary" onclick="completeSession()"><i class="bi bi-stop-fill me-1"></i>Complete</button>
        {% if request.user.is_superuser %}
        <button type="button" class="btn btn-danger" onclick="hardDeleteSession()"><i class="bi bi-trash me-1"></i>Delete Permanently</button>
        {% endif %}
        {% elif session.status == 'completed' %}
        {% if user.is_superuser or perms.core.can_revert_session %}
        <button type="button" class="btn btn-outline-primary" onclick="revertToScheduled()" title="Revert session back to scheduled status">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Revert to Scheduled
        </button>
        {% endif %}
        {% if request.user.is_superuser %}
        <button type="button" class="btn btn-danger" onclick="hardDeleteSession()"><i class="bi bi-trash me-1"></i>Delete Permanently</button>
        {% endif %}
        {% elif session.status == 'archived' %}
        {% if request.user.is_superuser %}
        <button type="button" class="btn btn-danger" onclick="hardDeleteSession()"><i class="bi bi-trash me-1"></i>Delete Permanently</button>
        {% endif %}
        {% endif %}
        <!-- Session Report PDF – always visible regardless of session status -->
        <button
            type="button"
            id="btn-download-report"
            class="btn btn-outline-info disabled"
            title="Generate a comprehensive PDF report for this session"
            data-session-id="{{ session.id }}"
            data-session-name="{{ session.name }}"
            data-session-date="{{ session.session_date|date:'Y-m-d' }}"
            data-session-status="{{ session.status }}"
            data-exam-name="{{ session.exam.name|default:'' }}"
            data-course-name="{{ session.exam.course.name|default:'' }}"
            data-department="{{ session.exam.department|default:'' }}"
        >
            <i class="bi bi-file-earmark-pdf me-1"></i>Session Report
        </button>
    </div>
</div>

<div class="row g-4">
    <!-- Paths Panel -->
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light d-flex flex-wrap justify-content-between align-items-center gap-2">
                <h5 class="mb-0"><i class="bi bi-signpost-split me-2"></i>Rotation Paths ({{ paths|length }})</h5>
                <div class="btn-group flex-wrap" role="group">
                    <a href="{% url 'creator:apply_station_templates' session.id %}" class="btn btn-sm btn-success" title="Apply station templates to all paths">
                        <i class="bi bi-layers me-1"></i>Apply Templates
                    </a>
                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#createMultiplePathsModal" title="Create multiple paths at once">
                        <i class="bi bi-scissors me-1"></i>Create Multiple
                    </button>
                    <a href="{% url 'creator:create_path' session.id %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>Add Path
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if paths %}
                <div class="row g-3">
                    {% for path in paths %}
                    <div class="col-md-4 col-lg-3">
                        <div class="card h-100 border">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">
                                        <a href="{% url 'creator:path_detail' path.id %}" class="text-decoration-none">
                                            <i class="bi bi-signpost text-primary me-1"></i>Path {{ path.name }}
                                        </a>
                                    </h6>
                                    <a href="{% url 'creator:edit_path' path.id %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></a>
                                </div>
                                <div class="small mb-2">
                                    <span class="badge bg-info me-1">{{ path.station_count }} stations</span>
                                    <span class="badge bg-success me-1">{{ path.total_marks }} marks</span>
                                </div>
                                {% if path.unassigned_count > 0 %}
                                <div class="path-details-toggle small" style="border-top: 1px solid #e9ecef; padding-top: 0.75rem;">
                                    <div class="d-flex align-items-center gap-1 mb-2">
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ path.unassigned_count }} unassigned
                                        </span>
                                    </div>
                                    <div class="text-warning fw-semibold">
                                        <i class="bi bi-person-x me-1"></i>
                                        No examiner: {% for s in path.unassigned_stations %}{{ s.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                <div class="small text-muted">
                                    <i class="bi bi-people me-1"></i>{{ path.student_count }} student{{ path.student_count|pluralize }} assigned
                                </div>
                                <div class="mt-2">
                                    <a href="{% url 'creator:station_create' path.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-plus-lg me-1"></i>Add Station
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="bi bi-signpost-split fs-1 d-block mb-2"></i>
                    No paths defined. Create paths to define student rotation sequences.<br>
                    <a href="{% url 'creator:create_path' session.id %}" class="btn btn-primary mt-2">
                        <i class="bi bi-plus-lg me-1"></i>Create First Path
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Students Panel -->
    <div class="col-md-8">
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h5 class="mb-0"><i class="bi bi-people me-2"></i>Students ({{ total_students }})</h5>
                {% if students %}
                <div class="btn-group btn-group-sm">
                    <a href="{% url 'creator:download_student_paths_pdf' session.id %}" class="btn btn-outline-primary" title="Download PDF with student path assignments">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF
                    </a>
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" {% if session.actual_start %}disabled{% endif %}>
                        <i class="bi bi-gear me-1"></i>Bulk Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% if not session.actual_start %}
                        <li><a class="dropdown-item" href="#" onclick="redistributeStudents()"><i class="bi bi-shuffle me-1"></i>Redistribute to Paths</a></li>
                        <li><hr class="dropdown-divider"></li>
                        {% endif %}
                        <li><a class="dropdown-item text-danger" href="#" onclick="confirmDeleteAllStudents()"><i class="bi bi-trash me-1"></i>Delete All Students</a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
            
            {# Search moved below add-students form to sit above the students list #}
            
            <!-- Add Students Form -->
            <div class="p-3 border-bottom">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#textInput"><i class="bi bi-textarea-t me-1"></i>Text Input</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#excelUpload"><i class="bi bi-file-earmark-spreadsheet me-1"></i>Excel Upload</button></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="textInput">
                        <form id="addStudentsForm" method="POST" action="{% url 'creator:add_students' session.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Add Students (one per line: student_number,full_name)</label>
                                <textarea class="form-control" id="studentListInput" name="student_list" rows="4" placeholder="12345,John Doe
12346,Jane Smith
12347,Bob Johnson" oninput="validateStudentNumbers()"></textarea>
                                <div id="studentValidationError" class="invalid-feedback d-block" style="display:none; color:#dc3545; font-size:0.875rem; margin-top:0.25rem;"></div>
                                <div class="form-text">Format: Registration Number (digits only), Full Name</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Assign to Path (optional)</label>
                                <select name="path_id" class="form-select">
                                    <option value="">-- Auto-distribute --</option>
                                    {% for path in paths %}
                                    <option value="{{ path.id }}">Path {{ path.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Auto-distribute will spread students evenly across paths</div>
                            </div>
                            <button type="submit" id="submitAddStudents" class="btn btn-primary">
                                <span id="textAddStudents"><i class="bi bi-plus-lg me-1"></i>Add Students</span>
                                <span id="spinnerAddStudents" class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="excelUpload">
                        <form id="uploadExcelForm" method="POST" action="{% url 'creator:upload_students_xlsx' session.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Upload Excel File (.xlsx)</label>
                                <input type="file" class="form-control" name="file" accept=".xlsx" required>
                                <div class="form-text">Excel columns: 1. Student Number, 2. Full Name</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Assign to Path (optional)</label>
                                <select name="path_id" class="form-select">
                                    <option value="">-- Auto-distribute --</option>
                                    {% for path in paths %}
                                    <option value="{{ path.id }}">Path {{ path.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" id="submitUploadExcel" class="btn btn-primary">
                                <span id="textUploadExcel"><i class="bi bi-upload me-1"></i>Upload Excel</span>
                                <span id="spinnerUploadExcel" class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </form>
                        <div class="mt-3 p-2 bg-light rounded">
                            <small class="text-muted"><strong>Required Format:</strong><br>Column A: ID/Number<br>Column B: Full Name</small>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if students %}
            <!-- Live Search Bar for Students -->
            {% if total_students > 10 %}
            <div class="p-3 border-bottom">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <div class="student-search-wrapper">
                        <i class="bi bi-search student-search-icon"></i>
                        <input type="text" id="studentLiveSearch"
                               class="form-control form-control-sm student-search-input"
                               placeholder="Search students by name or number..."
                               autocomplete="off" spellcheck="false"
                               data-search-url="{% url 'creator:live_student_search' session.id %}">
                        <button type="button" id="studentSearchClear"
                                class="student-search-clear d-none" title="Clear">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <small id="studentSearchStatus" class="text-muted"></small>
                </div>
            </div>
            {% endif %}
            <!-- Students Table with improved styling for large datasets -->
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-hover mb-0 table-sm">
                    <thead class="sticky-top" style="background: white; z-index: 10;">
                        <tr>
                            <th>Student #</th>
                            <th>Name</th>
                            <th>Path</th>
                            <th>Status</th>
                            <th class="text-center" style="width: 50px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="students-tbody">
                        {% for student in students %}
                        <tr>
                            <td><code class="text-primary fw-bold">{{ student.student_number }}</code></td>
                            <td>{{ student.full_name }}</td>
                            <td>
                                <select class="form-select form-select-sm" style="width: auto;" 
                                        onchange="updateStudentPath('{{ student.id }}', this.value)"
                                        {% if student.status != 'registered' %}disabled{% endif %}>
                                    <option value="">Unassigned</option>
                                    {% for path in paths %}
                                    <option value="{{ path.id }}" {% if student.path_id == path.id %}selected{% endif %}>Path {{ path.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                {% if student.status == 'registered' %}<span class="badge bg-primary">Registered</span>
                                {% elif student.status == 'checked_in' %}<span class="badge bg-info">Checked In</span>
                                {% elif student.status == 'in_progress' %}<span class="badge bg-warning">In Progress</span>
                                {% elif student.status == 'completed' %}<span class="badge bg-success">Completed</span>
                                {% elif student.status == 'absent' %}<span class="badge bg-danger">Absent</span>
                                {% else %}<span class="badge bg-secondary">{{ student.status|title }}</span>{% endif %}
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteStudent('{{ student.id }}', '{{ student.full_name }}')"
                                        {% if session.actual_start %}disabled{% endif %}
                                        title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            {% if paginator.num_pages > 1 %}
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <small class="text-muted">
                    Page {{ page_obj.number }} of {{ paginator.num_pages }} &mdash; 
                    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ paginator.count }}
                </small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"><i class="bi bi-chevron-double-left"></i></a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"><i class="bi bi-chevron-left"></i></a></li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-double-left"></i></span></li>
                        <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-left"></i></span></li>
                        {% endif %}
                        <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>
                        {% if page_obj.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"><i class="bi bi-chevron-right"></i></a></li>
                        <li class="page-item"><a class="page-link" href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"><i class="bi bi-chevron-double-right"></i></a></li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-right"></i></span></li>
                        <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-double-right"></i></span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            {% else %}
            <div class="p-4 text-center text-muted">
                <i class="bi bi-people fs-1 d-block mb-2"></i>No students added yet.
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Session Info & Examiner Sidebar -->
    <div class="col-md-4">
        <div class="sidebar-sticky-panel">
        <div class="stat-card mb-3">
            <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>Session Info</h6>
            <div class="row g-2">
                <div class="col-6">
                    <div class="text-muted small">Exam</div>
                    <strong class="small">{{ session.exam.name|default:"N/A"|truncatechars:30 }}</strong>
                </div>
                <div class="col-6">
                    <div class="text-muted small">Students</div>
                    <strong class="small">{{ total_students }}</strong>
                </div>
                <div class="col-6">
                    <div class="text-muted small">Rotation</div>
                    <strong class="small">{{ session_metrics.rotation_display }}</strong>
                </div>
                <div class="col-6">
                    <div class="text-muted small">Stations</div>
                    <strong class="small">{{ session_metrics.station_display }}</strong>
                </div>
                {% if total_unassigned > 0 and session.status != 'archived' %}
                <div class="col-12">
                    <div class="alert alert-warning py-2 px-2 mb-0" role="alert" onclick="togglePathDetails(event)" style="cursor: pointer; border-radius: 4px;">
                        <div class="d-flex align-items-center gap-2" style="font-size: 0.85rem;">
                            <i class="bi bi-exclamation-triangle-fill" style="flex-shrink: 0;"></i>
                            <small><strong>{{ total_unassigned }}</strong> station{{ total_unassigned|pluralize }} unassigned</small>
                            <i class="bi bi-chevron-down toggle-icon" style="margin-left: auto; font-size: 0.75rem;"></i>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Examiner Assignments -->
        <div class="stat-card mt-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="bi bi-person-badge me-2"></i>Examiner Assignments</h6>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignExaminerModal"><i class="bi bi-plus-lg"></i></button>
            </div>
            {% if examiner_assignments %}
            <div style="max-height: 240px; overflow-y: auto;">
            <ul class="list-group list-group-flush">
                {% for a in examiner_assignments %}
                <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                    <div class="me-2" style="min-width:0;">
                        <div class="fw-bold text-truncate small">{{ a.examiner.display_name|default:"Unknown" }}</div>
                        <div class="text-muted text-truncate" style="font-size:0.75rem;">{{ a.station_name }}</div>
                    </div>
                    <form method="POST" action="{% url 'creator:examiner_unassign' a.id %}" style="display: inline; flex-shrink:0;">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'creator:session_detail' session.id %}">
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove?')" {% if session.actual_start and not request.user.is_superuser %}disabled{% endif %}>
                            <i class="bi bi-x"></i>
                        </button>
                    </form>
                </li>
                {% endfor %}
            </ul>
            </div>
            {% else %}
            <p class="text-muted small mb-0">No examiners assigned yet.</p>
            {% endif %}
        </div>

        {% if submitted_scores %}
        <!-- Score Management side card -->
        <div class="mt-3" style="border-radius:12px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,.1);">
            <div class="d-flex justify-content-between align-items-center py-2 px-3"
                 style="background:#1e293b; cursor:pointer; user-select:none;"
                 onclick="toggleScorePanel()">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-shield-lock" style="color:#f59e0b; font-size:0.95rem;"></i>
                    <span style="color:#f1f5f9; font-weight:600; font-size:0.85rem;">Score Management</span>
                    <span class="badge ms-1" style="background:#334155; color:#94a3b8; font-size:0.7rem;">{{ submitted_scores|length }}</span>
                </div>
                <i class="bi bi-chevron-down" id="score-panel-chevron" style="color:#94a3b8; transition:transform 0.2s;"></i>
            </div>
            <div id="score-panel-body" style="display:none; background:#fff; border:1px solid #e2e8f0; border-top:none; border-radius:0 0 12px 12px;">
                <!-- Search -->
                <div class="px-2 pt-2 pb-1" style="border-bottom:1px solid #f1f5f9;">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" style="background:#fff; padding:3px 7px;"><i class="bi bi-search text-muted" style="font-size:0.72rem;"></i></span>
                        <input type="text" id="score-search" class="form-control form-control-sm" placeholder="Search…" oninput="filterScoreTable()" style="font-size:0.8rem;">
                        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="document.getElementById('score-search').value='';filterScoreTable();" style="padding:2px 6px;">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div style="font-size:0.7rem; color:#94a3b8; margin-top:2px;">
                        <span id="score-table-count">{{ submitted_scores|length }}</span> shown
                    </div>
                </div>
                <!-- Scrollable list -->
                <div style="max-height:340px; overflow-y:auto;">
                    <table class="table table-sm mb-0" id="score-mgmt-table" style="font-size:0.78rem;">
                        <thead style="position:sticky; top:0; z-index:1; background:#f8fafc;">
                            <tr>
                                <th style="font-size:0.72rem; padding:4px 8px;">Student</th>
                                <th style="font-size:0.72rem; padding:4px 8px;">Station / Examiner</th>
                                <th style="padding:4px 6px;"></th>
                            </tr>
                        </thead>
                        <tbody id="score-mgmt-tbody">
                            {% for sc in submitted_scores %}
                            <tr data-search="{{ sc.session_student.full_name|lower }} {{ sc.session_student.student_number|lower }} {{ sc.station.name|lower }} {{ sc.examiner.display_name|default:'deleted examiner'|lower }}">
                                <td style="padding:4px 8px;">
                                    <div class="fw-semibold" style="line-height:1.2;">{{ sc.session_student.full_name }}</div>
                                    <small class="text-muted">{{ sc.session_student.student_number }}</small>
                                </td>
                                <td style="padding:4px 8px;">
                                    <div style="line-height:1.2;">{{ sc.station.name|default:"—" }}</div>
                                    <small class="text-muted">{{ sc.examiner.display_name|default:"Deleted" }}</small>
                                </td>
                                <td style="padding:4px 6px; text-align:right; white-space:nowrap;">
                                    {% if sc.within_undo_window %}
                                    <span style="font-size:0.7rem; background:#dcfce7; border:1px solid #86efac; color:#166534; padding:2px 6px; border-radius:5px; display:inline-block;" title="Examiner can still edit within grace period">
                                        <i class="bi bi-pencil"></i> Editable
                                    </span>
                                    {% elif not sc.unlocked_for_correction %}
                                    <button type="button"
                                            style="background:#fef3c7; border:1px solid #f59e0b; color:#92400e; font-size:0.7rem; padding:2px 7px; border-radius:5px; cursor:pointer;"
                                            onclick="unlockScore('{{ sc.id }}', '{{ sc.session_student.full_name|escapejs }}', '{{ sc.examiner.display_name|default:"Deleted Examiner"|escapejs }}', '{{ sc.station.name|default:"Station"|escapejs }}')"
                                            title="Unlock for correction">
                                        <i class="bi bi-unlock"></i>
                                    </button>
                                    {% else %}
                                    <span style="font-size:0.75rem; color:#16a34a;" title="Awaiting correction"><i class="bi bi-check-circle"></i></span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="score-no-results" style="display:none; padding:14px; text-align:center; color:#94a3b8; font-size:0.78rem;">
                    <i class="bi bi-search me-1"></i>No match.
                </div>
            </div>
        </div>
        {% endif %}
        </div><!-- /sidebar-sticky-panel -->
    </div>
</div>

<!-- Bulk Assign Examiner Modal -->
<div class="modal fade" id="assignExaminerModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header bg-primary bg-opacity-10">
            <h5 class="modal-title"><i class="bi bi-person-badge me-2"></i>Bulk Assign Examiners</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="bulkAssignForm" method="POST" action="{% url 'creator:assign_examiner' session.id %}">
            {% csrf_token %}
            <div class="modal-body">
                <!-- Step 1: Select Path -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Select Path <span class="text-danger">*</span></label>
                    <select id="bulkAssignPathSelect" name="path_id" class="form-select" required>
                        <option value="">-- Choose a Path --</option>
                        {% for path in paths %}
                        <option value="{{ path.id }}">Path {{ path.name }} ({{ path.station_count }} station{{ path.station_count|pluralize }})</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Step 2: Dynamic station list loaded via AJAX -->
                <div id="bulkAssignStationsContainer">
                    <div class="text-center text-muted py-4" id="bulkAssignPlaceholder">
                        <i class="bi bi-arrow-up-circle fs-3 d-block mb-2"></i>
                        Select a path above to load its stations.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="bulkAssignSubmitBtn" disabled>
                    <i class="bi bi-check-lg me-1"></i>Save All Assignments
                </button>
            </div>
        </form>
    </div></div>
</div>

<!-- Create Multiple Paths Modal -->
<div class="modal fade" id="createMultiplePathsModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header bg-info bg-opacity-10">
            <h5 class="modal-title"><i class="bi bi-scissors me-2"></i>Create Multiple Paths</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <form id="batchPathForm" method="POST" action="{% url 'creator:batch_create_paths' session.id %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="pathCount" class="form-label">Number of Paths to Create <span class="text-danger">*</span></label>
                    <input type="number" class="form-control form-control-lg" id="pathCount" name="path_count" value="3" min="1" max="50" required>
                    <small class="form-text text-muted">Create between 1 and 50 paths at once</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Path Naming Pattern <span class="text-danger">*</span></label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="naming_pattern" id="pattern_letters" value="letters" checked>
                        <label class="btn btn-outline-primary" for="pattern_letters">A, B, C...</label>
                        <input type="radio" class="btn-check" name="naming_pattern" id="pattern_numbers" value="numbers">
                        <label class="btn btn-outline-primary" for="pattern_numbers">Path 1, Path 2...</label>
                    </div>
                </div>
                {% if paths %}
                <div class="mb-3">
                    <label for="copyFromPath" class="form-label">Copy Stations &amp; Checklist (Optional)</label>
                    <select class="form-select" id="copyFromPath" name="copy_from_path_id">
                        <option value="" data-minutes="">-- Don't copy --</option>
                        {% for path in paths %}
                        <option value="{{ path.id }}" data-minutes="{{ path.rotation_minutes }}">Path {{ path.name }} ({{ path.station_count }} station{{ path.station_count|pluralize }}, {{ path.rotation_minutes }} min)</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">All new paths will copy stations &amp; checklists from the selected path</small>
                </div>
                {% endif %}
                <div class="mb-3">
                    <label for="rotationMinutes" class="form-label d-flex align-items-center gap-2">
                        Minutes Per Station <span class="text-danger">*</span>
                    </label>
                    <input type="number" class="form-control" id="rotationMinutes" name="rotation_minutes"
                           value="{{ session.exam.station_duration_minutes|default:8 }}" min="1" max="60" required>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i><strong>What you'll get:</strong> All paths with same settings, ready to add stations or copy from existing paths
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-info" onclick="submitBatchPathForm()"><i class="bi bi-scissors me-1"></i>Create Paths</button>
        </div>
    </div></div>
</div>

<script>
function activateSession() {
    if (confirm('Activate this session? Examiners will be able to log in.')) {
        fetch('/api/creator/sessions/{{ session.id }}/activate', {method:'POST'})
        .then(r => r.json()).then(data => {
            if (data.error) alert('Error: ' + data.error);
            else { let msg = data.message; if (data.warnings && data.warnings.length > 0) msg += '\n\nWarnings:\n- ' + data.warnings.join('\n- '); alert(msg); location.reload(); }
        });
    }
}
function deactivateSession() {
    if (confirm('Pause this session?')) {
        fetch('/api/creator/sessions/{{ session.id }}/deactivate', {method:'POST'}).then(r=>r.json()).then(data=>{alert(data.message||'Session paused');location.reload();});
    }
}
function completeSession() {
    if (confirm('Complete this session?')) {
        fetch('/api/creator/sessions/{{ session.id }}/complete', {method:'POST'}).then(r=>r.json()).then(data=>{alert(data.message||'Session completed');location.reload();});
    }
}
function hardDeleteSession() {
    if (confirm('⚠️ PERMANENTLY DELETE this session?\n\nThis will delete all students, scores, and paths. This CANNOT be undone.')) {
        fetch('/api/creator/sessions/{{ session.id }}/hard-delete', {method:'POST'}).then(r=>r.json()).then(data=>{
            if (data.error) alert('Error: '+data.error); else {alert(data.message||'Session deleted'); window.location.href='/creator/exams/{{ session.exam.id }}/';}
        }).catch(err => alert('Error: ' + err.message));
    }
}
function revertToScheduled() {
    if (confirm('⚠️ Revert this completed session back to "Scheduled"?\n\nThis will allow the session to be re-activated. Existing scores will NOT be deleted.\n\nThis action is audited.')) {
        fetch('/api/creator/sessions/{{ session.id }}/revert-to-scheduled', {method:'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.error) { alert('Error: ' + data.error); }
            else { alert(data.message || 'Session reverted to scheduled'); location.reload(); }
        })
        .catch(err => alert('Request failed: ' + err.message));
    }
}
function updateStudentPath(studentId, pathId) {
    fetch(`/api/creator/students/${studentId}/path`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path_id:pathId||null})})
    .then(r=>{if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json();})
    .then(data=>{if(data.error)alert('Error: '+data.error);else location.reload();})
    .catch(err=>alert('Failed to update: '+err.message));
}
function deleteStudent(studentId, studentName) {
    {% if session.actual_start %}alert('Cannot delete students after session activation.');return;{% endif %}
    if (confirm(`Delete student "${studentName}"?`)) {
        fetch(`/api/creator/students/${studentId}`, {method:'DELETE'}).then(r=>r.json()).then(data=>{if(data.error)alert('Error: '+data.error);else location.reload();});
    }
}
function redistributeStudents() {
    {% if session.actual_start %}alert('Cannot redistribute after activation.');return;{% endif %}
    if (confirm('Redistribute all students evenly across paths?')) {
        fetch(`/api/creator/sessions/{{ session.id }}/redistribute-students`, {method:'POST'}).then(r=>r.json()).then(data=>{if(data.error)alert('Error: '+data.error);else{alert(data.message||'Redistributed');location.reload();}});
    }
}
function confirmDeleteAllStudents() {
    {% if session.actual_start %}alert('Cannot delete after activation.');return;{% endif %}
    if (confirm('DELETE ALL STUDENTS? This cannot be undone!')) {
        if (confirm('Are you really sure?')) {
            fetch(`/api/creator/sessions/{{ session.id }}/students`, {method:'DELETE'}).then(r=>r.json()).then(data=>{if(data.error)alert('Error: '+data.error);else{alert(data.message||'All deleted');location.reload();}});
        }
    }
}

// Validate student number format (digits only)
function validateStudentNumbers() {
    const textarea = document.getElementById('studentListInput');
    const errorDiv = document.getElementById('studentValidationError');
    const lines = textarea.value.trim().split('\n');
    const errors = [];
    
    lines.forEach((line, idx) => {
        if (!line.trim()) return; // skip empty lines
        if (!line.includes(',')) return; // skip lines without comma
        
        const parts = line.split(',');
        if (parts.length < 2) return;
        
        const number = parts[0].trim();
        if (!number) return; // skip empty numbers
        
        // Check if number contains only digits
        if (!/^\d+$/.test(number)) {
            errors.push(`Line ${idx + 1}: Registration number "${number}" must contain numbers only.`);
        }
    });
    
    if (errors.length > 0) {
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>' + errors.join('<br>');
        textarea.classList.add('is-invalid');
    } else {
        errorDiv.style.display = 'none';
        textarea.classList.remove('is-invalid');
    }
}

document.getElementById('addStudentsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate before submission
    validateStudentNumbers();
    const errorDiv = document.getElementById('studentValidationError');
    if (errorDiv.style.display !== 'none') {
        alert('Please fix validation errors before submitting.');
        return;
    }
    
    const btn=document.getElementById('submitAddStudents'), text=document.getElementById('textAddStudents'), spinner=document.getElementById('spinnerAddStudents');
    btn.disabled=true; text.innerHTML='<i class="bi bi-hourglass-split me-1"></i>Adding...'; spinner.classList.remove('d-none');
    fetch(this.action, {method:'POST', body:new FormData(this)})
    .then(r=>r.json()).then(data=>{
        if(data.success){let msg=data.message;if(data.warning)msg+='\n\n'+data.warning;alert(msg);location.reload();}
        else{
            let errorMsg = data.message;
            if(data.errors && data.errors.length > 0) {
                errorMsg += '\n\nErrors:\n' + data.errors.join('\n');
            }
            alert(errorMsg);
            btn.disabled=false;
            text.innerHTML='<i class="bi bi-plus-lg me-1"></i>Add Students';
            spinner.classList.add('d-none');
        }
    }).catch(err=>{alert('Error: '+err.message);btn.disabled=false;text.innerHTML='<i class="bi bi-plus-lg me-1"></i>Add Students';spinner.classList.add('d-none');});
});

document.getElementById('uploadExcelForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const btn=document.getElementById('submitUploadExcel'), text=document.getElementById('textUploadExcel'), spinner=document.getElementById('spinnerUploadExcel');
    btn.disabled=true; text.innerHTML='<i class="bi bi-hourglass-split me-1"></i>Uploading...'; spinner.classList.remove('d-none');
    fetch(this.action, {method:'POST', body:new FormData(this)})
    .then(r=>r.json()).then(data=>{
        if(data.success){let msg=data.message;if(data.warning)msg+='\n\n'+data.warning;alert(msg);location.reload();}
        else{
            let errorMsg = data.message;
            if(data.errors && data.errors.length > 0) {
                errorMsg += '\n\nErrors:\n' + data.errors.join('\n');
            }
            alert(errorMsg);
            btn.disabled=false;
            text.innerHTML='<i class="bi bi-upload me-1"></i>Upload Excel';
            spinner.classList.add('d-none');
        }
    }).catch(err=>{alert('Error: '+err.message);btn.disabled=false;text.innerHTML='<i class="bi bi-upload me-1"></i>Upload Excel';spinner.classList.add('d-none');});
});

function submitBatchPathForm() {
    const count = parseInt(document.getElementById('pathCount').value);
    if (count < 1 || count > 26) { alert('Enter 1-26'); return; }
    if (confirm(`Create ${count} path(s)?`)) document.getElementById('batchPathForm').submit();
}

// Lock/unlock duration when copying in bulk path creation modal
(function () {
    const modal = document.getElementById('createMultiplePathsModal');
    if (!modal) return;
    modal.addEventListener('shown.bs.modal', function () {
        const copySelect    = document.getElementById('copyFromPath');
        const durationInput = document.getElementById('rotationMinutes');
        const badge         = document.getElementById('bulk_duration_badge');
        const helpText      = document.getElementById('bulk_duration_help');
        if (!copySelect || !durationInput) return;
        const examDefault = {{ session.exam.station_duration_minutes|default:8 }};

        function update() {
            const selected = copySelect.options[copySelect.selectedIndex];
            const minutes  = selected.getAttribute('data-minutes');
            if (minutes) {
                durationInput.value = minutes;
                durationInput.readOnly = true;
                durationInput.style.backgroundColor = '#e9ecef';
                durationInput.style.cursor = 'not-allowed';
                if (badge) { badge.textContent = 'From: ' + selected.text.split('(')[0].trim(); badge.style.display = 'inline'; }
                if (helpText) helpText.innerHTML = '<i class="bi bi-lock me-1"></i>Taken from the copied path &mdash; adjust later in <strong>Edit Path</strong>';
            } else {
                durationInput.value = examDefault;
                durationInput.readOnly = false;
                durationInput.style.backgroundColor = '';
                durationInput.style.cursor = '';
                if (badge) badge.style.display = 'none';
                if (helpText) helpText.innerHTML = 'Inherited from exam (' + examDefault + ' min) &mdash; you can change it';
            }
        }
        copySelect.removeEventListener('change', update);
        copySelect.addEventListener('change', update);
    });
})();

function toggleScorePanel() {
    const body = document.getElementById('score-panel-body');
    const chevron = document.getElementById('score-panel-chevron');
    if (!body) return;
    const open = body.style.display !== 'none';
    body.style.display = open ? 'none' : 'block';
    chevron.style.transform = open ? '' : 'rotate(180deg)';
}

function filterScoreTable() {
    const q = document.getElementById('score-search').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#score-mgmt-tbody tr');
    let shown = 0;
    rows.forEach(row => {
        const haystack = row.dataset.search || '';
        const match = !q || haystack.includes(q);
        row.style.display = match ? '' : 'none';
        if (match) shown++;
    });
    document.getElementById('score-table-count').textContent = shown;
    document.getElementById('score-no-results').style.display = shown === 0 ? 'block' : 'none';
    document.getElementById('score-mgmt-table').style.display = shown === 0 ? 'none' : '';
}

function unlockScore(scoreId, studentName, examinerName, stationName) {
    if (!confirm(`Unlock score for "${studentName}" at "${stationName}" by "${examinerName}"?\n\nThis will allow the examiner to correct and re-submit their evaluation.`)) return;
    fetch(`/creator/scores/${scoreId}/unlock/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Could not unlock'));
        }
    })
    .catch(err => alert('Error: ' + err.message));
}

// ── Bulk Examiner Assignment Modal ─────────────────────────────────────
(function() {
    const pathSelect = document.getElementById('bulkAssignPathSelect');
    const container = document.getElementById('bulkAssignStationsContainer');
    const placeholder = document.getElementById('bulkAssignPlaceholder');
    const submitBtn = document.getElementById('bulkAssignSubmitBtn');
    const form = document.getElementById('bulkAssignForm');

    if (!pathSelect) return;

    pathSelect.addEventListener('change', function() {
        const pathId = this.value;
        if (!pathId) {
            container.innerHTML = '';
            container.appendChild(placeholder);
            placeholder.style.display = '';
            submitBtn.disabled = true;
            return;
        }

        // Show loading
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary" role="status"></div><span class="ms-2 text-muted">Loading stations…</span></div>';
        submitBtn.disabled = true;

        // AJAX fetch stations partial
        fetch(`/creator/sessions/{{ session.id }}/path/${pathId}/stations-for-assignment/`)
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.text();
            })
            .then(html => {
                container.innerHTML = html;
                // Enable submit only if there are station rows
                const selects = container.querySelectorAll('.examiner-1-select');
                submitBtn.disabled = selects.length === 0;

                // Initialize Select2 on all examiner dropdowns (searchable + scrollable)
                if (typeof $ !== 'undefined' && $.fn.select2) {
                    $(container).find('.examiner-1-select, .examiner-2-select').select2({
                        theme: 'bootstrap-5',
                        placeholder: '-- Search examiner --',
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#assignExaminerModal'),
                    }).on('change', function() { validateBulkForm(); });
                } else {
                    // Fallback: plain listeners if Select2 not loaded
                    selects.forEach(sel => {
                        sel.addEventListener('change', validateBulkForm);
                    });
                    container.querySelectorAll('.examiner-2-select').forEach(sel => {
                        sel.addEventListener('change', validateBulkForm);
                    });
                }
            })
            .catch(err => {
                container.innerHTML = '<div class="alert alert-danger py-2 small"><i class="bi bi-exclamation-triangle me-1"></i>Failed to load stations: ' + err.message + '</div>';
                submitBtn.disabled = true;
            });
    });

    // Client-side validation
    function validateBulkForm() {
        const e1Selects = container.querySelectorAll('.examiner-1-select');
        let allValid = true;

        e1Selects.forEach(sel => {
            const stationId = sel.dataset.stationId;
            const e2 = container.querySelector(`select[name="examiner_2_${stationId}"]`);

            // Examiner 1 is required
            if (!sel.value) {
                sel.classList.add('is-invalid');
                allValid = false;
            } else {
                sel.classList.remove('is-invalid');
            }

            // Examiner 1 and 2 can't be same
            if (e2 && sel.value && e2.value && sel.value === e2.value) {
                e2.classList.add('is-invalid');
                allValid = false;
            } else if (e2) {
                e2.classList.remove('is-invalid');
            }
        });

        submitBtn.disabled = !allValid;
        return allValid;
    }

    // Form submit validation
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateBulkForm()) {
                e.preventDefault();
                alert('Please fill in all required Examiner 1 fields and fix any errors.');
                return false;
            }
        });
    }

    // Reset modal when closed
    const modal = document.getElementById('assignExaminerModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            // Destroy Select2 instances before clearing
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $(container).find('.examiner-1-select, .examiner-2-select').select2('destroy');
            }
            pathSelect.value = '';
            container.innerHTML = '';
            if (placeholder) {
                container.appendChild(placeholder);
                placeholder.style.display = '';
            }
            submitBtn.disabled = true;
        });
    }
})();

// ── Live Student Search (in-table filter) ──────────────────────────────
(function () {
    const searchInput  = document.getElementById('studentLiveSearch');
    const clearBtn     = document.getElementById('studentSearchClear');
    const statusEl     = document.getElementById('studentSearchStatus');
    const tbody        = document.getElementById('students-tbody');
    if (!searchInput || !tbody) return;

    const SEARCH_URL    = searchInput.dataset.searchUrl;
    const SESSION_STARTED = {{ session.actual_start|yesno:'true,false' }};
    // Available paths for building the select options in search results
    const SESSION_PATHS = [
        {% for path in paths %}{"id":"{{ path.id }}","name":"{{ path.name }}"}{% if not forloop.last %},{% endif %}{% endfor %}
    ];

    // Snapshot the original server-rendered rows
    const originalRows = tbody.innerHTML;

    let lastQuery = '';

    const STATUS_BADGE = {
        registered:  'bg-primary',
        checked_in:  'bg-info text-dark',
        in_progress: 'bg-warning text-dark',
        completed:   'bg-success',
        absent:      'bg-danger',
    };

    function performSearch(q) {
        if (q.length < 2) { restoreOriginal(); lastQuery = ''; return; }
        if (q === lastQuery) return;

        // Show spinner row while waiting
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-muted"><span class="spinner-border spinner-border-sm me-1"></span>Searching…</td></tr>';
        if (statusEl) statusEl.textContent = '';

        lastQuery = q;
        fetch(SEARCH_URL + '?q=' + encodeURIComponent(q), {
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(function (r) { return r.ok ? r.json() : {results: []}; })
        .then(function (data) {
            const students = data.results || [];
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-muted"><i class="bi bi-person-x me-1"></i>No students match your search.</td></tr>';
                if (statusEl) statusEl.textContent = 'No results';
            } else {
                tbody.innerHTML = students.map(buildRow).join('');
                if (statusEl) statusEl.textContent = students.length + (students.length === 20 ? '+ matches (top 20)' : ' match' + (students.length === 1 ? '' : 'es'));
            }
        })
        .catch(function () { restoreOriginal(); });
    }


    function buildRow(s) {
        const badge   = STATUS_BADGE[s.status] || 'bg-secondary';
        const label   = s.status.replace(/_/g, ' ');
        const disabled = (s.status !== 'registered' || SESSION_STARTED) ? ' disabled' : '';

        let pathOpts = '<option value="">Unassigned</option>';
        SESSION_PATHS.forEach(function (p) {
            const sel = (p.id === s.path_id) ? ' selected' : '';
            pathOpts += `<option value="${p.id}"${sel}>Path ${p.name}</option>`;
        });

        const deleteDis = SESSION_STARTED ? ' disabled' : '';

        return `<tr>
            <td><code class="text-primary fw-bold">${s.student_number}</code></td>
            <td>${s.full_name}</td>
            <td>
                <select class="form-select form-select-sm" style="width:auto;"
                        onchange="updateStudentPath('${s.id}', this.value)"${disabled}>
                    ${pathOpts}
                </select>
            </td>
            <td><span class="badge ${badge}">${label}</span></td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger"
                        onclick="deleteStudent('${s.id}', ${JSON.stringify(s.full_name)})"
                        title="Delete"${deleteDis}>
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>`;
    }

    function restoreOriginal() {
        tbody.innerHTML = originalRows;
        if (statusEl) statusEl.textContent = '';
    }

    searchInput.addEventListener('blur', function () {
        const q = this.value.trim();
        if (q.length >= 2) {
            performSearch(q);
        }
    });

    searchInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const q = this.value.trim();
            if (q.length >= 2) {
                performSearch(q);
            } else {
                restoreOriginal();
            }
        }
    });

    // Update clear button visibility as user types
    searchInput.addEventListener('input', function () {
        const q = this.value.trim();
        clearBtn.classList.toggle('d-none', q.length === 0);
    });

    clearBtn.addEventListener('click', function () {
        searchInput.value = '';
        lastQuery = '';
        clearBtn.classList.add('d-none');
        restoreOriginal();
        searchInput.focus();
    });
})();

// Toggle per-path details visibility
function togglePathDetails(event) {
    event.preventDefault();
    const alert = event.currentTarget;
    const isCollapsed = alert.classList.contains('collapsed');
    
    // Toggle the alert styling
    alert.classList.toggle('collapsed');
    
    // Toggle all path-details-toggle elements
    const details = document.querySelectorAll('.path-details-toggle');
    details.forEach(detail => {
        if (isCollapsed) {
            // Was collapsed, now expand
            detail.classList.add('show');
        } else {
            // Was expanded, now collapse
            detail.classList.remove('show');
        }
    });
}
</script>
{% endblock %}

{% block extra_js %}
<!-- jQuery (required for Select2) + Select2 -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- jsPDF 2.5.1 + AutoTable 3.8.2 (served locally) -->
<script src="{% static 'js/jspdf.umd.min.js' %}"></script>
<script src="{% static 'js/jspdf.plugin.autotable.min.js' %}"></script>
<!-- Session Report PDF generator -->
<script src="{% static 'js/session-report-pdf.js' %}"></script>
<script>
(function () {
    const btn = document.getElementById('btn-download-report');
    if (!btn) return;
    btn.addEventListener('click', function () {
        const meta = {
            sessionName:   btn.dataset.sessionName,
            sessionDate:   btn.dataset.sessionDate,
            sessionStatus: btn.dataset.sessionStatus,
            examName:      btn.dataset.examName,
            courseName:    btn.dataset.courseName,
            department:    btn.dataset.department,
        };
        generateSessionReport(btn.dataset.sessionId, meta);
    });
})();
</script>
{% endblock %}
