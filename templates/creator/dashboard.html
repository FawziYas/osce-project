{% extends 'creator/base_creator.html' %}

{% block title %}OSCE Creator - Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
    <p class="text-muted mb-0">OSCE Creator &amp; Examiner System</p>
</div>

<!-- Draft Exams Alert -->
{% if stats.draft_exams > 0 %}
<div class="alert alert-warning mt-4" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    You have <strong>{{ stats.draft_exams }}</strong> exam(s) in draft status.
    <a href="{% url 'creator:exam_list' %}" class="alert-link">Review and finalize</a>
</div>
{% endif %}



<!-- Stats Row -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon theme-3 me-3"><i class="bi bi-calendar-event"></i></div>
                <div>
                    <div class="stat-value">{{ stats.exams }}</div>
                    <div class="stat-label">Exams</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon theme-2 me-3"><i class="bi bi-pencil-square"></i></div>
                <div>
                    <div class="stat-value">{{ stats.draft_exams }}</div>
                    <div class="stat-label">Draft Exams</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon theme-6 me-3"><i class="bi bi-archive"></i></div>
                <div>
                    <div class="stat-value">{{ stats.archived_exams }}</div>
                    <div class="stat-label">Archived Exams</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon theme-5 me-3"><i class="bi bi-play-circle"></i></div>
                <div>
                    <div class="stat-value">{{ stats.active_sessions }}</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Recent Exams -->
    <div class="col-md-8">
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Recent Exams</h5>
                <a href="{% url 'creator:exam_create' %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-lg me-1"></i>New Exam
                </a>
            </div>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Course</th>
                        <th>Stations</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for exam in exams %}
                    <tr>
                        <td>
                            <a href="{% url 'creator:exam_detail' exam.id %}" class="text-decoration-none">
                                {{ exam.name }}
                            </a>
                        </td>
                        <td>
                            {% if exam.course %}
                                <span class="badge bg-secondary">{{ exam.course.code }}</span>
                            {% endif %}
                        </td>
                        <td>{{ exam.stations.count }}</td>
                        <td>
                            <span class="badge badge-{{ exam.status }}">{{ exam.status|title }}</span>
                        </td>
                        <td>{{ exam.exam_date|date:"Y-m-d"|default:"-" }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'creator:exam_detail' exam.id %}" 
                                   class="btn btn-outline-primary" title="View">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if exam.status == 'draft' or exam.status == 'ready' %}
                                    <button type="button" class="btn btn-outline-danger" title="Delete"
                                            data-bs-toggle="modal" data-bs-target="#deleteExamModal" 
                                            data-exam-id="{{ exam.id }}" data-exam-name="{{ exam.name }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                {% elif exam.status == 'in_progress' or exam.status == 'completed' %}
                                    <button type="button" class="btn btn-outline-warning" title="Archive"
                                            data-bs-toggle="modal" data-bs-target="#archiveExamModal" 
                                            data-exam-id="{{ exam.id }}" data-exam-name="{{ exam.name }}">
                                        <i class="bi bi-archive"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                            No exams yet. <a href="{% url 'creator:exam_create' %}">Create your first exam</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="col-md-4">
        <div class="stat-card mb-3">
            <h5 class="mb-3"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
            <div class="d-grid gap-2">
                <a href="{% url 'creator:course_create' %}" class="btn btn-outline-primary">
                    <i class="bi bi-plus-lg me-2"></i>Add Course
                </a>
                <a href="{% url 'creator:library_item_create' %}" class="btn btn-outline-primary">
                    <i class="bi bi-plus-lg me-2"></i>Add Library Item
                </a>
            </div>
        </div>
        
        <!-- Active Courses -->
        <div class="stat-card">
            <h5 class="mb-3"><i class="bi bi-journals me-2"></i>Active Courses</h5>
            <ul class="list-group list-group-flush">
                {% for course in courses|slice:":5" %}
                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                    <a href="{% url 'creator:course_detail' course.id %}" 
                       class="text-decoration-none">
                        <strong>{{ course.code }}</strong>
                        <span class="text-muted ms-2">{{ course.name }}</span>
                    </a>
                    <span class="badge bg-secondary">Y{{ course.year_level }}</span>
                </li>
                {% empty %}
                <li class="list-group-item text-center text-muted px-0">
                    No courses yet
                </li>
                {% endfor %}
            </ul>
            {% if courses|length > 5 %}
            <a href="{% url 'creator:course_list' %}" class="btn btn-link btn-sm mt-2">
                View all {{ courses|length }} courses
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Exam Modal -->
<div class="modal fade" id="deleteExamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger bg-opacity-10">
                <h5 class="modal-title text-danger"><i class="bi bi-trash me-2"></i>Delete Exam</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong>Delete exam: <span id="deleteExamName">-</span>?</strong></p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>This will permanently delete:</strong>
                    <ul class="mb-0 mt-2"><li>All associated sessions</li><li>All paths and stations</li></ul>
                </div>
                <p class="small text-muted"><i class="bi bi-info-circle me-1"></i>This exam can be restored later if needed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteExamBtn"><i class="bi bi-trash me-1"></i>Delete Exam</button>
            </div>
        </div>
    </div>
</div>

<!-- Archive Exam Modal -->
<div class="modal fade" id="archiveExamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10">
                <h5 class="modal-title text-warning"><i class="bi bi-archive me-2"></i>Archive Exam</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong>Archive exam: <span id="archiveExamName">-</span>?</strong></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>This will archive:</strong>
                    <ul class="mb-0 mt-2"><li>All sessions and student data</li><li>All marks and assessments</li></ul>
                </div>
                <p class="small text-muted"><i class="bi bi-info-circle me-1"></i>Archived exams remain accessible for review and can be restored.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="archiveExamBtn"><i class="bi bi-archive me-1"></i>Archive Exam</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedExamId = null;

document.getElementById('deleteExamModal')?.addEventListener('show.bs.modal', function(e) {
    const button = e.relatedTarget;
    selectedExamId = button.dataset.examId;
    document.getElementById('deleteExamName').textContent = button.dataset.examName;
});

document.getElementById('deleteExamBtn')?.addEventListener('click', function() {
    if (!selectedExamId) return;
    fetch(`/creator/exams/${selectedExamId}/delete`, {
        method: 'POST', headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('Error: ' + (data.message || 'Unknown error')); } })
    .catch(err => alert('Error: ' + err.message));
});

document.getElementById('archiveExamModal')?.addEventListener('show.bs.modal', function(e) {
    const button = e.relatedTarget;
    selectedExamId = button.dataset.examId;
    document.getElementById('archiveExamName').textContent = button.dataset.examName;
});

document.getElementById('archiveExamBtn')?.addEventListener('click', function() {
    if (!selectedExamId) return;
    fetch(`/creator/exams/${selectedExamId}/archive`, {
        method: 'POST', headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('Error: ' + (data.message || 'Unknown error')); } })
    .catch(err => alert('Error: ' + err.message));
});
</script>
{% endblock %}
